<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>议事详情 - 事件脉络追踪</title>

  <!-- 强制禁用缓存 - 开发环境 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="-1">
  <meta http-equiv="Last-Modified" content="0">
  <meta http-equiv="If-Modified-Since" content="0">

  <!-- External Dependencies -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Base Styles -->
  <link rel="stylesheet" href="assets/css/variables.css">
  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/layout.css">
  <link rel="stylesheet" href="assets/css/utilities.css">

  <!-- Main Styles (fallback) -->
  <link rel="stylesheet" href="assets/styles.css">

  <!-- Error Handling and Logging -->
  <script src="assets/js/logger.js"></script>
  <script src="assets/js/error-handler.js"></script>

  <script>
    // Component loading error handler
    window.addEventListener('error', (event) => {
      if (event.filename && event.filename.includes('/components/')) {
        console.error('Component loading error:', event.error);
      }
    });

    // Show loading indicator
    document.addEventListener('DOMContentLoaded', () => {
      const loadingIndicator = document.getElementById('loading-indicator');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'flex';
      }
    });
  </script>
</head>

<body>
  <!-- Loading Indicator -->
  <div id="loading-indicator" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    flex-direction: column;
    gap: 16px;
  ">
    <div style="
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0052D9;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    "></div>
    <p style="color: #666; font-size: 14px; margin: 0;">正在加载组件...</p>
  </div>

  <!-- Navbar Component Container -->
  <div id="navbar-container">
    <!-- Fallback navbar content -->
    <div class="navbar fallback-navbar">
      <div class="navbar-back" onclick="history.back()" role="button" tabindex="0" aria-label="返回上一页">
        <i class="fas fa-chevron-left icon-md"></i>
      </div>
      <div class="navbar-title td-text-primary">议事详情</div>
      <div class="navbar-capsule">
        <button class="capsule-btn" title="更多选项" aria-label="显示更多选项">
          <i class="fas fa-ellipsis-h icon-sm"></i>
        </button>
        <div class="capsule-divider"></div>
        <button class="capsule-btn" onclick="window.close()" title="关闭页面" aria-label="关闭当前页面">
          <i class="fas fa-times icon-sm"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="content">
    <!-- 议题信息区 -->
    <div class="section-card">
      <!-- 主标题区域 - H1级别 -->
      <div class="topic-title">
        <span class="topic-title-text" id="topic-title-text">加载中...</span>
        <span class="topic-status topic-status-badge" id="topic-status">加载中</span>
      </div>

      <!-- 元信息区域 - 次要信息级别 -->
      <div class="meta-info">
        <div class="meta-item">
          <img id="topic-author-avatar" src="" alt="发起人头像" class="avatar-xs">
          <span class="meta-author" id="topic-author-name">加载中...</span>
        </div>
        <div class="meta-item font-normal">
          <i class="fas fa-clock meta-time-icon"></i>
          <span id="topic-timestamp">加载中...</span>
        </div>
      </div>


      <!-- 间距分隔 -->
      <div class="spacer-lg"></div>

      <!-- 议题详细信息 - H3级别内容区域 -->
      <div class="topic-details">
        <div class="topic-detail-item"><span class="topic-detail-label">讨论背景：</span><span class="topic-detail-value"
            id="topic-background">加载中...</span></div>
        <div class="topic-detail-item"><span class="topic-detail-label">核心议题：</span><span class="topic-detail-value"
            id="topic-core-issue">加载中...</span></div>
        <div class="topic-detail-item"><span class="topic-detail-label">争议焦点：</span><span class="topic-detail-value"
            id="topic-controversy">加载中...</span></div>
        <div class="topic-detail-item"><span class="topic-detail-label">关键问题：</span><span class="topic-detail-value"
            id="topic-key-question">加载中...</span></div>
        <div class="topic-detail-item"><span class="topic-detail-label">期待结果：</span><span class="topic-detail-value"
            id="topic-expected-result">加载中...</span></div>
      </div>

      <!-- AI润色提示卡片 -->
      <div class="ai-polish-card" id="ai-polish-card" style="display: none;">
        <div class="ai-polish-icon">
          <img src="assets/lficon/magicpen.svg" alt="魔法笔">
        </div>
        <div class="ai-polish-text">
          <span class="ai-polish-text-normal" id="ai-polish-message">该文本由AI润色，</span>
          <span class="ai-polish-link" onclick="alert('功能开发中，敬请期待！')">你也来试试吧！</span>
        </div>
      </div>



      <!-- 相关附件 - H3级别子标题 -->
      <div class="attachments-section">
        <div class="attachments-title">相关附件</div>
        <div id="figma-attachment-list" class="attachment-list"></div>
      </div>


    </div>





    <!-- Discussion Section Component Container -->
    <div id="discussion-container">
      <!-- Fallback discussion content -->
      <div class="discussion-section fallback-discussion">
        <div class="discussion-section-header">
          <div class="discussion-title-container">
            <span>讨论区</span>
          </div>
          <div class="discussion-actions-container">
            <button onclick="window.location.href='topic-detail.html'" class="discussion-btn">
              <img src="assets/lficon/messages.svg" alt="消息">
              <span>去议事</span>
            </button>
          </div>
        </div>
        <div id="detailed-comments-section" class="comments-section-container">
          <!-- Comments Component Container -->
          <div id="comments-container">
            <!-- Fallback comments content -->
            <div id="comments-list">
              <div class="loading-placeholder">
                <p>正在加载评论...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Assistant Component Container -->
  <div id="ai-assistant-container">
    <!-- AI assistant component will be loaded here -->
  </div>

  <!-- Component Loading and Initialization Script -->
  <script type="module">
    import { initializeComponents } from './assets/js/main.js';

    // Add loading animation styles
    const style = document.createElement('style');
    style.textContent = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .fallback-navbar {
        background: #f8f9fa;
        border-bottom: 1px solid #e5e7eb;
        padding: 8px 16px;
      }
      
      .fallback-discussion {
        background: #f8f9fa;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin: 16px;
        padding: 16px;
      }
      
      .component-error {
        background: #fee2e2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 16px;
        margin: 16px;
        color: #dc2626;
        text-align: center;
      }
    `;
    document.head.appendChild(style);

    // Initialize components when DOM is ready
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log('Starting component initialization...');

        // Initialize all components
        await initializeComponents();

        // Hide loading indicator
        const loadingIndicator = document.getElementById('loading-indicator');
        if (loadingIndicator) {
          loadingIndicator.style.opacity = '0';
          setTimeout(() => {
            loadingIndicator.style.display = 'none';
          }, 300);
        }

        console.log('All components initialized successfully');

        // Dispatch custom event for any additional initialization
        document.dispatchEvent(new CustomEvent('componentsReady'));

      } catch (error) {
        console.error('Error initializing components:', error);

        // Hide loading indicator and show error
        const loadingIndicator = document.getElementById('loading-indicator');
        if (loadingIndicator) {
          loadingIndicator.innerHTML = `
            <div class="component-error">
              <h3>组件加载失败</h3>
              <p>部分功能可能不可用，请刷新页面重试</p>
              <button onclick="location.reload()" style="
                margin-top: 12px;
                padding: 8px 16px;
                background: #dc2626;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              ">刷新页面</button>
            </div>
          `;
        }
      }
    });

    // Global error handler for component failures
    window.addEventListener('error', (event) => {
      if (event.filename && event.filename.includes('/components/')) {
        console.error('Component runtime error:', event.error);

        // Show user-friendly error message
        const toast = document.createElement('div');
        toast.textContent = '组件运行出错，部分功能可能受影响';
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: #dc2626;
          color: white;
          padding: 12px 24px;
          border-radius: 8px;
          z-index: 10000;
          font-size: 14px;
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 5000);
      }
    });

    // Expose component loader for debugging
    window.addEventListener('componentsLoaded', (event) => {
      console.log('Components loaded:', event.detail);

      // Make component functions available globally for backward compatibility
      // This ensures existing onclick handlers still work
      if (window.NavbarController) {
        window.showMoreOptions = window.NavbarController.showMoreOptions;
        window.closeApp = window.NavbarController.closeApp;
      }

      if (window.CommentsController) {
        window.toggleLike = window.CommentsController.toggleLike;
        window.toggleDislike = window.CommentsController.toggleDislike;
        window.replyComment = window.CommentsController.replyComment;
        window.sendFlower = window.CommentsController.sendFlower;
        window.toggleReplies = window.CommentsController.toggleReplies;
      }

      if (window.DiscussionController) {
        window.sortComments = window.DiscussionController.sortComments;
      }

      if (window.AIController) {
        window.toggleAIAssistant = window.AIController.toggleAIAssistant;
        window.updateAIAnalysis = window.AIController.updateAIAnalysis;
      }
    });
  </script>
  <!-- Bottom Comment Input -->
  <div id="bottom-comment-box" style="
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid #E5E7EB;
    padding: 8px 16px;
    z-index: 9999;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
  ">
    <div style="display: flex; align-items: center; gap: 8px; max-width: 100%; margin: 0 auto;">
      <div style="flex: 1; position: relative; display: flex; align-items: center;">
        <textarea id="comment-input" placeholder="说点什么吧~" style="
            width: 100%;
            min-height: 16px;
            max-height: 40px;
            padding: 6px 36px 6px 12px;
            border: 1px solid #E5E7EB;
            border-radius: 16px;
            resize: none;
            font-size: 14px;
            line-height: 1.4;
            background: #F9FAFB;
            outline: none;
            transition: all 0.2s ease;
            box-sizing: border-box;
            font-family: 'PingFang SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          "></textarea>
        <button onclick="selectImage()" style="
            background: none;
            border: none;
            padding: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            cursor: pointer;
            position: absolute;
            right: 4px;
            z-index: 1;
            border-radius: 4px;
          ">
          <img src="assets/lficon/Image.svg" style="width: 16px; height: 16px;" alt="添加图片">
        </button>
      </div>
      <button onclick="sendComment()" style="
          background: none;
          border: none;
          padding: 6px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease;
          cursor: pointer;
          border-radius: 4px;
        ">
        <img src="assets/lficon/send.svg" style="width: 18px; height: 18px;" alt="发送">
      </button>
    </div>
  </div>

  <!-- Comment Input Functionality -->
  <script>
    // Utility functions for comment input
    function adjustTextareaHeight(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    function selectImage() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = function (e) {
        const file = e.target.files[0];
        if (file) {
          console.log('选择的图片：', file.name);
          // Show feedback
          const toast = document.createElement('div');
          toast.textContent = '图片选择成功：' + file.name;
          toast.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #10B981;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 14px;
          `;
          document.body.appendChild(toast);
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 3000);
        }
      };
      input.click();
    }

    function sendComment() {
      const textarea = document.getElementById('comment-input');
      const content = textarea.value.trim();

      if (!content) {
        // Show error feedback
        const toast = document.createElement('div');
        toast.textContent = '请输入评论内容';
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: #EF4444;
          color: white;
          padding: 12px 24px;
          border-radius: 8px;
          z-index: 10000;
          font-size: 14px;
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 3000);
        return;
      }

      console.log('发送评论：', content);

      // Show success feedback
      const toast = document.createElement('div');
      toast.textContent = '评论发送成功';
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #10B981;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 10000;
        font-size: 14px;
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 3000);

      // Clear input
      textarea.value = '';
      textarea.style.height = 'auto';
    }

    // Auto-resize textarea and focus handling
    document.addEventListener('DOMContentLoaded', function () {
      const textarea = document.getElementById('comment-input');
      if (textarea) {
        textarea.addEventListener('input', () => adjustTextareaHeight(textarea));
        textarea.addEventListener('focus', () => {
          textarea.style.borderColor = '#0052D9';
          textarea.style.background = 'white';
        });
        textarea.addEventListener('blur', () => {
          textarea.style.borderColor = '#E5E7EB';
          textarea.style.background = '#F9FAFB';
        });
      }

      // Add bottom padding to body to avoid comment box overlap
      document.body.style.paddingBottom = '60px';
    });
  </script>

  <script>
    // AI速览切换功能
    function toggleAISummary() {
      const aiComment = document.getElementById('ai-assistant-comment');
      const toggleBtn = document.getElementById('ai-summary-toggle-btn');
      const discussionSection = document.querySelector('.discussion-section');
      const allComments = discussionSection.querySelectorAll('.comment-item:not(#ai-assistant-comment)');

      if (aiComment.style.display === 'none') {
        // 显示AI速览，隐藏其他评论
        aiComment.style.display = 'block';
        allComments.forEach(comment => {
          comment.style.display = 'none';
        });
        toggleBtn.innerHTML = '<i class="fas fa-comments" style="margin-right: 4px;"></i>返回评论区';
      } else {
        // 隐藏AI速览，显示其他评论
        aiComment.style.display = 'none';
        allComments.forEach(comment => {
          comment.style.display = 'block';
        });
        toggleBtn.innerHTML = '<img src="assets/lficon/ailogo.svg" style="width: 20px; height: 20px; margin-right: 4px;" ' +
          'alt="AI">AI速览';
      }
    }

    // AI速览卡片收起展开功能
    function toggleAIOverview() {
      const detailsSection = document.getElementById('ai-overview-details');
      const expandBtn = document.getElementById('ai-overview-expand-btn');
      const expandIcon = expandBtn.querySelector('.expand-icon');
      const gradientLayer = document.getElementById('ai-overview-gradient');

      // 检查当前状态：如果隐藏或者没有设置display属性，则认为是收起状态
      const isHidden = detailsSection.style.display === 'none' || detailsSection.style.display === '';

      if (isHidden) {
        // 展开详细信息
        detailsSection.style.display = 'block';
        // 使用transform旋转箭头，确保方向正确
        expandIcon.style.transform = 'rotate(180deg)';
        expandBtn.classList.add('expanded');
        gradientLayer.style.display = 'none';
      } else {
        // 收起详细信息
        detailsSection.style.display = 'none';
        // 恢复箭头原始方向
        expandIcon.style.transform = 'rotate(0deg)';
        expandBtn.classList.remove('expanded');
        gradientLayer.style.display = 'block';
      }
    }

    /**
    * AI速览刷新功能
    * 点击刷新按钮后更新显示时间
    */
    function refreshAISummary() {
      const refreshStatus = document.getElementById('refresh-status');
      const now = new Date();

      // 格式化时间为 HH:MM 格式
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const timeString = `${hours}:${minutes}`;

      // 更新显示文本为具体刷新时间
      if (refreshStatus) {
        refreshStatus.textContent = `刷新于 ${timeString}`;
      }

      // 可以在这里添加实际的AI数据刷新逻辑
      console.log('AI速览已刷新，时间：', timeString);
    }

    // 页面加载时初始化
    window.addEventListener('DOMContentLoaded', function () {
      const aiComment = document.getElementById('ai-assistant-comment');
      if (aiComment) {
        aiComment.style.display = 'none';
      }

      // 初始化bullet-comments动画
      initBulletCommentsAnimation();
    });

    // Bullet Comments 动态效果
    function initBulletCommentsAnimation() {
      const bulletComments = document.querySelectorAll('.bullet-comment');

      // 为每个评论添加延迟动画
      bulletComments.forEach((comment, index) => {
        comment.style.animationDelay = `${index * 0.1}s`;
      });
    }

    // 模拟新评论动态添加
    function addNewBulletComment(text, type = 'normal') {
      const bulletList = document.querySelector('.bullet-comments-list');
      const newComment = document.createElement('div');
      newComment.className = `bullet-comment bullet-comment-${type}`;

      // 根据评论类型决定显示的按钮
      let actionsHTML = '';
      if (type === 'controversial') {
        // 争议评论只显示点踩按钮
        actionsHTML = `
  <div class="bullet-dislike" onclick="bulletToggleDislike(this)">
    <img src="assets/lficon/thumbs-up-outline.svg" class="comment-action-icon-rotated" alt="点踩">
    <span>0</span>
  </div>
  <span class="bullet-badge bullet-badge-controversial"><i class="fas fa-bolt"></i> 争议</span>
  `;
      } else {
        // 其他类型显示点赞按钮
        actionsHTML = `
  <div class="bullet-like" onclick="bulletToggleLike(this)">
    <img src="assets/lficon/thumbs-up-outline.svg" class="comment-action-icon" alt="点赞">
    <span>0</span>
  </div>
  `;

        // 为特殊类型添加标签
        if (type === 'hot') {
          actionsHTML += '<span class="bullet-badge bullet-badge-hot"><i class="fas fa-fire"></i> 热门</span>';
        } else if (type === 'quality') {
          actionsHTML += '<span class="bullet-badge bullet-badge-quality"><i class="fas fa-gem"></i> 优质</span>';
        }
      }

      // 使用真实用户名列表
      const realUsernames = ['李小明', '孙工程师', '赵女士', '周业主', '钱租户', '张业主', '业委会老李'];
      const randomUsername = realUsernames[Math.floor(Math.random() * realUsernames.length)];

      newComment.innerHTML = `
  <span class="bullet-text"><span class="bullet-username">${randomUsername}</span>：${text}</span>
  <div class="bullet-actions">
    ${actionsHTML}
  </div>
  `;

      // 添加进入动画
      newComment.style.opacity = '0';
      newComment.style.transform = 'translateY(20px)';
      bulletList.appendChild(newComment);

      // 触发动画
      setTimeout(() => {
        newComment.style.transition = 'all 0.3s ease-out';
        newComment.style.opacity = '1';
        newComment.style.transform = 'translateY(0)';
      }, 100);

      // 更新评论数量
      updateCommentCount();
    }

    // 更新评论数量
    function updateCommentCount() {
      const countElement = document.querySelector('.bullet-comments-count .count-number');
      const currentCount = parseInt(countElement.textContent);
      countElement.textContent = currentCount + 1;
    }

    // 切换详细分析内容显示
    function toggleDetailedAnalysis() {
      const detailedAnalysis = document.getElementById('detailed-analysis');
      const expandBtn = document.querySelector('.expand-replies-btn');
      const expandText = expandBtn.querySelector('.expand-text');
      const aiIcon = expandBtn.querySelector('.ai-icon');
      const backIcon = expandBtn.querySelector('.back-icon');

      if (detailedAnalysis.style.display === 'none' || detailedAnalysis.style.display === '') {
        // 显示详细分析
        detailedAnalysis.style.display = 'block';
        expandText.textContent = '返回评论区';
        aiIcon.style.display = 'none';
        backIcon.style.display = 'inline-block';
      } else {
        // 隐藏详细分析
        detailedAnalysis.style.display = 'none';
        expandText.textContent = '一键分析评论';
        aiIcon.style.display = 'inline-block';
        backIcon.style.display = 'none';
      }
    }



    /**
    * 初始化Tabs组件的键盘导航功能
    * 支持左右箭头键切换tab，符合ARIA标准
    */
    function initTabsKeyboardNavigation() {
      const tabsList = document.querySelector('.tabs-list');
      if (!tabsList) return; // Exit if tabs don't exist on this page
      const triggers = tabsList.querySelectorAll('.tabs-trigger');

      triggers.forEach((trigger, index) => {
        trigger.addEventListener('keydown', (e) => {
          let nextIndex;

          switch (e.key) {
            case 'ArrowLeft':
              e.preventDefault();
              nextIndex = index === 0 ? triggers.length - 1 : index - 1;
              triggers[nextIndex].focus();
              break;
            case 'ArrowRight':
              e.preventDefault();
              nextIndex = index === triggers.length - 1 ? 0 : index + 1;
              triggers[nextIndex].focus();
              break;
            case 'Home':
              e.preventDefault();
              triggers[0].focus();
              break;
            case 'End':
              e.preventDefault();
              triggers[triggers.length - 1].focus();
              break;
            case 'Enter':
            case ' ':
              e.preventDefault();
              trigger.click();
              break;
          }
        });
      });
    }

    /**
    * 跳转到讨论详情页面
    * 点击"查看详情评论"时调用此函数
    */
    function navigateToDiscussionDetail() {
      // 添加点击反馈效果
      const clickedElement = event.target.closest('.bullet-comments-count');
      if (clickedElement) {
        clickedElement.style.transform = 'scale(0.95)';
        clickedElement.style.opacity = '0.8';

        setTimeout(() => {
          clickedElement.style.transform = 'scale(1)';
          clickedElement.style.opacity = '1';
        }, 150);
      }

      // 这里可以根据实际需求跳转到具体的讨论详情页面
      // 示例：跳转到讨论详情页面（需要根据实际页面路径调整）
      // window.location.href = 'discussion-detail.html';

      // 或者在当前页面显示更详细的评论内容
      console.log('跳转到讨论详情页面');
      alert('功能开发中：将跳转到完整的讨论详情页面');
    }

    /**
    * 显示更多选项菜单
    * 微信小程序胶囊按钮 - 更多功能
    */
    function showMoreOptions() {
      // 创建选项菜单
      const options = [
        { text: '分享给朋友', icon: 'fas fa-share', action: () => shareToFriend() },
        { text: '收藏', icon: 'fas fa-star', action: () => addToFavorites() },
        { text: '举报', icon: 'fas fa-flag', action: () => reportContent() },
        { text: '设置', icon: 'fas fa-cog', action: () => openSettings() }
      ];

      // 显示选项菜单（这里可以实现一个弹出菜单）
      const menuText = options.map(opt => opt.text).join('\n');
      const choice = prompt('请选择操作：\n' + menuText);

      const selectedOption = options.find(opt => opt.text === choice);
      if (selectedOption) {
        selectedOption.action();
      }
    }

    /**
    * 关闭应用
    * 微信小程序胶囊按钮 - 关闭功能
    */
    function closeApp() {
      if (confirm('确定要关闭当前页面吗？')) {
        // 在微信小程序中，这里会调用 wx.navigateBack() 或 wx.exitMiniProgram()
        // 在网页中，我们使用 window.close() 或返回上一页
        if (window.history.length > 1) {
          window.history.back();
        } else {
          window.close();
        }
      }
    }

    /**
    * 分享给朋友功能
    */
    function shareToFriend() {
      // 在实际微信小程序中，这里会调用 wx.shareAppMessage()
      if (navigator.share) {
        navigator.share({
          title: '业主委员会津贴标准与权责分配讨论',
          text: '参与社区议事，共建美好家园',
          url: window.location.href
        });
      } else {
        // 复制链接到剪贴板
        navigator.clipboard.writeText(window.location.href).then(() => {
          alert('链接已复制到剪贴板');
        });
      }
    }

    /**
    * 添加到收藏功能
    */
    function addToFavorites() {
      // 在实际应用中，这里会保存到用户的收藏列表
      const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
      const currentPage = {
        title: '业主委员会津贴标准与权责分配讨论',
        url: window.location.href,
        timestamp: Date.now()
      };

      if (!favorites.find(item => item.url === currentPage.url)) {
        favorites.push(currentPage);
        localStorage.setItem('favorites', JSON.stringify(favorites));
        alert('已添加到收藏');
      } else {
        alert('已经在收藏中了');
      }
    }

    /**
    * 举报内容功能
    */
    function reportContent() {
      const reason = prompt('请输入举报原因：');
      if (reason && reason.trim()) {
        // 在实际应用中，这里会发送举报信息到服务器
        console.log('举报原因：', reason);
        alert('举报已提交，感谢您的反馈');
      }
    }

    /**
    * 打开设置页面
    */
    function openSettings() {
      alert('设置功能开发中');
    }

    // 页面加载完成后初始化键盘导航
    document.addEventListener('DOMContentLoaded', function () {
      initTabsKeyboardNavigation();
    });
  </script>

  <!-- 底部固定评论框 -->
  <div id="bottom-comment-box"
    style="position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #E5E7EB; padding: 8px 16px; z-index: 9999; box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1); padding-bottom: calc(8px + env(safe-area-inset-bottom)); transform: translateZ(0); will-change: transform; backface-visibility: hidden;">
    <div style="display: flex; align-items: center; gap: 8px; max-width: 100%; margin: 0 auto;">
      <!-- 评论输入框容器 -->
      <div style="flex: 1; position: relative; display: flex; align-items: center;">
        <!-- 评论输入框 -->
        <textarea id="comment-input" placeholder="说点什么吧~"
          style="width: 100%; min-height: 16px; max-height: 40px; padding: 6px 36px 6px 12px; border: 1px solid #E5E7EB; border-radius: 16px; resize: none; font-size: 14px; line-height: 1.4; background: #F9FAFB; outline: none; transition: all 0.2s ease; box-sizing: border-box; font-family: 'PingFang SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;"
          oninput="adjustTextareaHeight(this)"
          onfocus="this.style.borderColor='#0052D9'; this.style.background='white';"
          onblur="this.style.borderColor='#E5E7EB'; this.style.background='#F9FAFB';"></textarea>

        <!-- 图片上传按钮（在输入框内部右侧） -->
        <button onclick="selectImage()"
          style="background: none; border: none; padding: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; cursor: pointer; position: absolute; right: 4px; z-index: 1; border-radius: 4px;"
          onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='none'">
          <img src="assets/lficon/Image.svg"
            style="width: 16px; height: 16px; filter: brightness(0) saturate(100%) invert(45%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(95%) contrast(95%);"
            alt="添加图片">
        </button>
      </div>

      <!-- 发送按钮 -->
      <button onclick="sendComment()"
        style="background: none; border: none; padding: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; cursor: pointer; border-radius: 4px;"
        onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='none'">
        <img src="assets/lficon/send.svg" style="width: 18px; height: 18px;" alt="发送">
      </button>
    </div>
  </div>

  <script>
    /**
     * 自动调整文本框高度
     * @param {HTMLTextAreaElement} textarea - 文本框元素
     */
    function adjustTextareaHeight(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    /**
     * 选择图片功能
     */
    function selectImage() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = function (e) {
        const file = e.target.files[0];
        if (file) {
          // 在实际应用中，这里会上传图片到服务器
          console.log('选择的图片：', file.name);
          alert('图片选择成功：' + file.name);
        }
      };
      input.click();
    }

    /**
     * 发送评论功能
     */
    function sendComment() {
      const textarea = document.getElementById('comment-input');
      const content = textarea.value.trim();

      if (!content) {
        alert('请输入评论内容');
        return;
      }

      // 在实际应用中，这里会发送评论到服务器
      console.log('发送评论：', content);

      // 模拟发送成功
      alert('评论发送成功');

      // 清空输入框
      textarea.value = '';
      textarea.style.height = 'auto';
    }

    // 为页面主体添加底部间距，避免被评论框遮挡
    document.addEventListener('DOMContentLoaded', function () {
      const body = document.body;
      body.style.paddingBottom = '60px';
    });
  </script>

</body>

</html>